# 2048 Solver Go実装設計

## 概要

Expectimaxアルゴリズムと重み付けカーネル評価関数を組み合わせた2048ソルバーのGo実装。

## 探索アルゴリズム: Expectimax

### 構造

ゲーム木を2種類のノードで構成：

1. **MAXノード（プレイヤーの手番）**
   - 4方向（上下左右）の中から最高評価値の手を選択
   - `max(子ノードの評価値)`

2. **CHANCEノード（タイル生成）**
   - 空きマスにランダムでタイルが生成される
   - 期待値を計算: `0.9 × E[2が出る] + 0.1 × E[4が出る]`

### 探索の流れ

```
BestMove(盤面)
  └─ 各方向について
       └─ expectedScore(スワイプ後の盤面, depth-1)
            └─ 各空きマスについて（サンプリング）
                 ├─ searchMax(2を配置, depth)
                 └─ searchMax(4を配置, depth)
                      └─ expectedScore(スワイプ後, depth-1)
                           └─ ... (深さ0まで再帰)
```

### サンプリング

計算量削減のため、空きマスが多い場合は最大6マスをサンプリング。
均等に分散して選択することで、偏りを軽減。

## 評価関数: 重み付けカーネル

### 設計思想

1. **単調性と角ボーナスの統合**: 個別に評価せず、位置重み行列で一括評価
2. **空きマスの影響調整**: 最大タイルの対数に依存させ、支配的にならないよう抑制
3. **マージ可能性**: 隣接する同値タイルにボーナス

### 評価式

```
Score = MaxTileValue × 10
      + WeightedPositionScore / 1000
      + EmptyCells × log₂(MaxTile) × 5
      + MergeBonus
```

### 重み付けカーネル（スネークパターン）

4つの角それぞれを基準にした指数的重み行列を用意し、最高スコアを採用。

**左上基準の例:**
```
┌───────┬───────┬───────┬───────┐
│ 32768 │ 16384 │  8192 │  4096 │  ← 最大タイルはここに
├───────┼───────┼───────┼───────┤
│   256 │   512 │  1024 │  2048 │
├───────┼───────┼───────┼───────┤
│   128 │    64 │    32 │    16 │
├───────┼───────┼───────┼───────┤
│     1 │     2 │     4 │     8 │
└───────┴───────┴───────┴───────┘
```

**位置スコア計算:**
```
WeightedPositionScore = Σ (タイル値[i,j] × 重み[i,j])
```

この設計により：
- 大きいタイルが角にあると高評価（重み32768）
- スネーク状に降順で並ぶと高評価
- 乱れた配置は低評価

### マージボーナス

```
MergeBonus = Σ (log₂(隣接同値タイル) × 2)
```

大きいタイル同士のマージほど重要度が高い。

## Go実装の特徴

### BitBoard表現

- 64ビット整数で盤面全体を表現（各セル4ビット）
- ビット演算による高速なスワイプ処理
- メモリ効率的な状態表現

### 実装されたソルバー

1. **通常のSolver** (`domain.Solver`)
   - 標準的なExpectimax実装
   - 2次元配列による盤面表現

2. **BitBoardSolver** (`domain.BitBoardSolver`)
   - BitBoard表現を使用
   - 約8倍の高速化

3. **A*Solver** (`domain.AStarSolver`)
   - A*アルゴリズムによる枝刈り
   - ヒューリスティクスを用いた効率的な探索

## パラメータ

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| 探索深さ | 4 | MAXノードの最大深さ |
| サンプル数 | 6 | CHANCEノードで評価する空きマス数 |
| 2の出現確率 | 90% | タイル生成時 |
| 4の出現確率 | 10% | タイル生成時 |

## 性能

- 2048達成: 約50%
- 4096達成: 約20%
- BitBoard実装により約8倍の高速化